{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}Rate Facial Expressions{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Session Progress -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Facial Expression Classification</h5>
                        <span class="badge bg-primary">
                            Session {{ progress.current }} of {{ progress.total }}
                        </span>
                    </div>
                </div>
                
                {% if image %}
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <small>Session Progress</small>
                            <small>{{ progress.current }} of {{ progress.total }} images</small>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: {% widthratio progress.current progress.total 100 %}%"
                                 aria-valuenow="{{ progress.current }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ progress.total }}">
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-8">
                                <i class="fas fa-dice me-2"></i>
                                <strong>Random Session Length:</strong> This session contains 
                                <span class="badge bg-primary">{{ progress.total }}</span> images 
                                (randomly selected between {{ progress.min_images }} and {{ progress.max_images }}).
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Estimated: {{ progress.total|mul:2 }} minutes
                                </small>
                            </div>
                        </div>
                    </div>
                    <!-- Image Display -->
                    <div class="text-center mb-5">
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body p-3">
                                <h6 class="mb-2">Image Code: <code class="bg-white p-1 rounded">{{ image.code }}</code></h6>
                                <img src="{{ image.image.url }}" 
                                     alt="Facial expression to classify" 
                                     class="img-fluid rounded shadow" 
                                     style="max-height: 400px; max-width: 100%;">
                            </div>
                        </div>
                        <p class="text-muted">
                            <i class="fas fa-info-circle"></i> Use the sliders below to rank emotional states from 1 (most consistent) to {{ emotions.count }} (least consistent)
                        </p>
                    </div>

                    <!-- Ranking Form -->
                    <form method="post" id="rankingForm">
                        {% csrf_token %}
                        <input type="hidden" name="image_id" value="{{ image.id }}">
                        
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <i class="fas fa-sliders-h me-2"></i>
                                Rank Emotional States
                            </h5>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                Drag each slider to rank emotional states from 1 (most consistent) to {{ emotions.count }} (least consistent) 
                                for this facial expression. Each number can only be used once.
                            </div>
                            
                            <!-- Rank Legend -->
                            <div class="rank-legend mb-3">
                                <div class="d-flex justify-content-between small text-muted">
                                    <span><i class="fas fa-arrow-left"></i> Least Consistent</span>
                                    <span>Drag sliders to rank</span>
                                    <span>Most Consistent <i class="fas fa-arrow-right"></i></span>
                                </div>
                            </div>
                        </div>

                        <!-- Emotional States Ranking with Sliders -->
                        <div class="emotion-sliders-container">
                            {% for emotion in emotions %}
                            <div class="emotion-slider-card mb-3 p-3 border rounded" data-emotion-id="{{ emotion.id }}">
                                <div class="row align-items-center">
                                    <!-- Emotion Info -->
                                    <div class="col-md-4">
                                        <h6 class="mb-1">{{ emotion.name }}</h6>
                                        {% if emotion.description %}
                                        <small class="text-muted">{{ emotion.description|truncatechars:60 }}</small>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Slider -->
                                    <div class="col-md-6">
                                        <div class="slider-container">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small class="text-muted">1 (Most)</small>
                                                <small class="text-muted">{{ emotions.count }} (Least)</small>
                                            </div>
                                            <input type="range" 
                                                   class="form-range emotion-slider"
                                                   min="1"
                                                   max="{{ emotions.count }}"
                                                   step="1"
                                                   value="{{ forloop.counter }}"
                                                   data-emotion-id="{{ emotion.id }}"
                                                   data-emotion-name="{{ emotion.name }}">
                                            
                                            <!-- Hidden input for form submission -->
                                            <input type="hidden" 
                                                   name="emotion_{{ emotion.id }}"
                                                   class="rank-value-input"
                                                   value="{{ forloop.counter }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Current Rank Display -->
                                    <div class="col-md-2 text-center">
                                        <div class="rank-display">
                                            <div class="rank-value-badge">
                                                <span class="badge bg-primary rank-number" 
                                                      style="font-size: 1.2rem; min-width: 40px;">
                                                    {{ forloop.counter }}
                                                </span>
                                            </div>
                                            <small class="text-muted d-block mt-1">Current Rank</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Used Ranks Visualization -->
                        <div class="card mt-4 mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-list-ol me-2"></i> Used Ranks Summary
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="used-ranks-visualization">
                                    <div class="d-flex flex-wrap gap-2 justify-content-center" id="ranksContainer">
                                        {% for i in emotions|length|get_range %}
                                        <div class="rank-pill rank-{{ forloop.counter }}" 
                                             data-rank="{{ forloop.counter }}">
                                            <span class="badge rank-badge" 
                                                  style="font-size: 0.9rem; padding: 0.5rem 0.75rem;">
                                                {{ forloop.counter }}
                                            </span>
                                            <div class="rank-emotion-name small mt-1 text-center">
                                                <em>Empty</em>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Each number represents a unique rank. Drag sliders to assign emotional states.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Validation and Submission -->
                        <div class="mt-5 pt-4 border-top">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="alert alert-warning" id="validationAlert" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="validationMessage"></span>
                                    </div>
                                    <div class="alert alert-success" id="validRanksAlert" style="display: none;">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <span>All ranks are properly assigned! You can now submit.</span>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="validationCheck" required>
                                        <label class="form-check-label" for="validationCheck">
                                            I confirm that I have ranked all emotional states appropriately
                                        </label>
                                        <div class="invalid-feedback">
                                            Please confirm your rankings before proceeding.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                        {% if progress.current == progress.total %}
                                            <i class="fas fa-flag-checkered me-2"></i> Finish Session
                                        {% else %}
                                            <i class="fas fa-arrow-right me-2"></i> Next Image
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                {% else %}
                <!-- No Images Available -->
                <div class="card-body text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h4 class="mb-3">All Images Have Been Rated!</h4>
                    <p class="text-muted mb-4">
                        There are no more images available for classification in this session.
                    </p>
                    <a href="{% url 'faceStudy:session_complete' %}" class="btn btn-success btn-lg px-4">
                        <i class="fas fa-trophy me-2"></i> Complete Session
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Instructions Panel -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i> Classification Instructions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>How to Use Sliders:</h6>
                            <ul class="small">
                                <li class="mb-2">
                                    <strong>Drag left</strong>: Lower rank number (more consistent with expression)
                                </li>
                                <li class="mb-2">
                                    <strong>Drag right</strong>: Higher rank number (less consistent with expression)
                                </li>
                                <li class="mb-2">
                                    <strong>Unique ranks</strong>: Each number from 1 to {{ emotions.count }} is used once
                                </li>
                                <li class="mb-2">
                                    <strong>Automatic adjustment</strong>: Moving one slider automatically adjusts others to prevent duplicates
                                </li>
                                <li>
                                    <strong>Visual feedback</strong>: Used ranks are highlighted in the summary below
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Ranking Tips:</h6>
                            <ul class="small">
                                <li class="mb-2">
                                    <i class="fas fa-eye text-primary me-1"></i> Focus on overall facial expression, not just one feature
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-sync-alt text-primary me-1"></i> You can adjust multiple times until you're satisfied
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-balance-scale text-primary me-1"></i> Compare emotions relative to each other
                                </li>
                                <li>
                                    <i class="fas fa-check-double text-primary me-1"></i> All ranks must be assigned before submitting
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Ranking Validation -->
<div class="modal fade" id="rankingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i> Ranking Validation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle me-2"></i>
                    Remember: Each number from 1 to {{ emotions.count }} must be used exactly once.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Review Rankings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('rankingForm');
    const validationCheck = document.getElementById('validationCheck');
    const validationAlert = document.getElementById('validationAlert');
    const validRanksAlert = document.getElementById('validRanksAlert');
    const validationMessage = document.getElementById('validationMessage');
    const sliders = document.querySelectorAll('.emotion-slider');
    const hiddenInputs = document.querySelectorAll('.rank-value-input');
    const modal = new bootstrap.Modal(document.getElementById('rankingModal'));
    const modalMessage = document.getElementById('modalMessage');
    const submitBtn = document.getElementById('submitBtn');
    const ranksContainer = document.getElementById('ranksContainer');
    
    // Initialize rank mapping
    let rankMap = new Map(); // key: rank number, value: {emotionId, emotionName}
    let emotionMap = new Map(); // key: emotionId, value: {rank, slider, hiddenInput}
    
    // Initialize data structures
    sliders.forEach(slider => {
        const emotionId = slider.dataset.emotionId;
        const emotionName = slider.dataset.emotionName;
        const currentRank = parseInt(slider.value);
        const hiddenInput = document.querySelector(`input[name="emotion_${emotionId}"]`);
        
        emotionMap.set(emotionId, {
            rank: currentRank,
            slider: slider,
            hiddenInput: hiddenInput,
            name: emotionName
        });
        
        rankMap.set(currentRank, {
            emotionId: emotionId,
            emotionName: emotionName
        });
        
        // Update visual display for this emotion
        updateEmotionDisplay(emotionId, currentRank);
    });
    
    // Update rank visualization
    updateRankVisualization();
    
    // Slider change handler
    sliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const emotionId = this.dataset.emotionId;
            const newRank = parseInt(this.value);
            const oldRank = emotionMap.get(emotionId).rank;
            
            // Check if new rank is already taken
            if (rankMap.has(newRank) && rankMap.get(newRank).emotionId !== emotionId) {
                // Swap ranks with the emotion that currently has this rank
                const otherEmotionId = rankMap.get(newRank).emotionId;
                const otherEmotion = emotionMap.get(otherEmotionId);
                
                // Update other emotion to old rank
                otherEmotion.rank = oldRank;
                otherEmotion.slider.value = oldRank;
                otherEmotion.hiddenInput.value = oldRank;
                rankMap.set(oldRank, {
                    emotionId: otherEmotionId,
                    emotionName: otherEmotion.name
                });
                
                // Update other emotion display
                updateEmotionDisplay(otherEmotionId, oldRank);
            }
            
            // Update current emotion
            emotionMap.get(emotionId).rank = newRank;
            emotionMap.get(emotionId).hiddenInput.value = newRank;
            rankMap.set(newRank, {
                emotionId: emotionId,
                emotionName: emotionMap.get(emotionId).name
            });
            
            // Update display
            updateEmotionDisplay(emotionId, newRank);
            updateRankVisualization();
            validateRanks();
        });
    });
    
    // Update emotion display (badge, etc.)
    function updateEmotionDisplay(emotionId, rank) {
        const emotionCard = document.querySelector(`[data-emotion-id="${emotionId}"]`);
        const rankBadge = emotionCard.querySelector('.rank-number');
        
        // Update badge
        rankBadge.textContent = rank;
        
        // Update badge color based on rank position
        const totalEmotions = sliders.length;
        const rankPercent = (rank - 1) / (totalEmotions - 1);
        
        if (rankPercent < 0.33) {
            rankBadge.className = 'badge bg-success rank-number';
        } else if (rankPercent < 0.66) {
            rankBadge.className = 'badge bg-warning rank-number';
        } else {
            rankBadge.className = 'badge bg-secondary rank-number';
        }
    }
    
    // Update rank visualization
    function updateRankVisualization() {
        const rankPills = ranksContainer.querySelectorAll('.rank-pill');
        
        rankPills.forEach(pill => {
            const rank = parseInt(pill.dataset.rank);
            const badge = pill.querySelector('.rank-badge');
            const emotionNameSpan = pill.querySelector('.rank-emotion-name');
            
            if (rankMap.has(rank)) {
                const emotionInfo = rankMap.get(rank);
                badge.className = 'badge bg-primary rank-badge';
                emotionNameSpan.textContent = emotionInfo.emotionName;
                emotionNameSpan.className = 'rank-emotion-name small mt-1 text-center';
            } else {
                badge.className = 'badge bg-light text-dark rank-badge';
                emotionNameSpan.textContent = 'Empty';
                emotionNameSpan.className = 'rank-emotion-name small mt-1 text-center text-muted';
            }
        });
    }
    
    // Validate ranks
    function validateRanks() {
        const usedRanks = new Set();
        const missingRanks = [];
        
        // Check all emotions have unique ranks
        for (let i = 1; i <= sliders.length; i++) {
            if (rankMap.has(i)) {
                usedRanks.add(i);
            } else {
                missingRanks.push(i);
            }
        }
        
        const isValid = usedRanks.size === sliders.length && missingRanks.length === 0;
        
        // Show/hide validation alerts
        if (isValid) {
            validationAlert.style.display = 'none';
            validRanksAlert.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-primary');
        } else {
            validRanksAlert.style.display = 'none';
            
            if (missingRanks.length > 0) {
                validationMessage.textContent = `Missing ranks: ${missingRanks.join(', ')}`;
                validationAlert.style.display = 'block';
            }
            
            submitBtn.disabled = false; // Still allow submission, but warn
        }
        
        return isValid;
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Check confirmation
        if (!validationCheck.checked) {
            validationCheck.classList.add('is-invalid');
            modalMessage.textContent = 'Please confirm that you have ranked all emotional states appropriately.';
            modal.show();
            return;
        }
        
        // Validate ranks
        const validation = validateRanks();
        
        if (!validation) {
            modalMessage.textContent = 'Please ensure all ranks are properly assigned before submitting.';
            modal.show();
            return;
        }
        
        // If all validations pass, submit the form
        this.submit();
    });
    
    // Clear validation on checkbox change
    validationCheck.addEventListener('change', function() {
        this.classList.remove('is-invalid');
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
            validationCheck.checked = true;
            form.dispatchEvent(new Event('submit'));
        }
    });
    
    // Initial validation
    validateRanks();
});

// Custom template filter for range (if not already defined)
if (typeof window.getRange === 'undefined') {
    window.getRange = function(n) {
        return Array.from({length: n}, (_, i) => i + 1);
    };
}
</script>

<style>
/* Slider Styles */
.emotion-slider-card {
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    border-left: 4px solid #4e73df !important;
}

.emotion-slider-card:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.form-range.emotion-slider {
    height: 8px;
    cursor: pointer;
}

.form-range.emotion-slider::-webkit-slider-thumb {
    background-color: #4e73df;
    border: 2px solid #fff;
    width: 20px;
    height: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.form-range.emotion-slider::-moz-range-thumb {
    background-color: #4e73df;
    border: 2px solid #fff;
    width: 20px;
    height: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.form-range.emotion-slider::-webkit-slider-runnable-track {
    background: linear-gradient(to right, #4e73df, #f8f9fa);
    height: 8px;
    border-radius: 4px;
}

.form-range.emotion-slider::-moz-range-track {
    background: linear-gradient(to right, #4e73df, #f8f9fa);
    height: 8px;
    border-radius: 4px;
}

/* Rank Visualization */
.rank-pill {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem;
    border-radius: 8px;
    min-width: 60px;
    transition: all 0.3s ease;
}

.rank-pill:hover {
    transform: scale(1.05);
}

.rank-badge {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rank-emotion-name {
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Rank Display */
.rank-value-badge {
    margin-bottom: 0.5rem;
}

.rank-number {
    font-size: 1.2rem;
    min-width: 40px;
    display: inline-block;
    transition: all 0.3s ease;
}

/* Progress Bar Animation */
.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .emotion-slider-card {
        padding: 1rem !important;
    }
    
    .emotion-slider-card .row > div {
        margin-bottom: 0.5rem;
    }
    
    .rank-pill {
        min-width: 50px;
    }
    
    .rank-badge {
        width: 35px;
        height: 35px;
        font-size: 0.8rem;
    }
    
    .btn-lg {
        width: 100%;
        margin-top: 1rem;
    }
}

/* Custom scrollbar for sliders container */
.emotion-sliders-container {
    max-height: 500px;
    overflow-y: auto;
    padding-right: 5px;
}

.emotion-sliders-container::-webkit-scrollbar {
    width: 8px;
}

.emotion-sliders-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.emotion-sliders-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.emotion-sliders-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Used ranks visualization */
.used-ranks-visualization {
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
}
</style>
{% endblock %}