{% extends 'base.html' %}

{% block title %}Rate Facial Expressions{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Session Progress -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Facial Expression Classification</h5>
                        <span class="badge bg-primary">
                            Session {{ progress.current }} of {{ progress.total }}
                        </span>
                    </div>
                </div>
                
                {% if image %}
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <small>Session Progress</small>
                            <small>{{ progress.current }} of {{ progress.total }} images</small>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: {% widthratio progress.current progress.total 100 %}%"
                                 aria-valuenow="{{ progress.current }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ progress.total }}">
                            </div>
                        </div>
                    </div>

                    <!-- Image Display -->
                    <div class="text-center mb-5">
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body p-3">
                                <h6 class="mb-2">Image Code: <code class="bg-white p-1 rounded">{{ image.code }}</code></h6>
                                <img src="{{ image.image.url }}" 
                                     alt="Facial expression to classify" 
                                     class="img-fluid rounded shadow" 
                                     style="max-height: 400px; max-width: 100%;">
                            </div>
                        </div>
                        <p class="text-muted">
                            <i class="fas fa-info-circle"></i> Please rank the emotional states below based on this facial expression
                        </p>
                    </div>

                    <!-- Ranking Form -->
                    <form method="post" id="rankingForm">
                        {% csrf_token %}
                        <input type="hidden" name="image_id" value="{{ image.id }}">
                        
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <i class="fas fa-sort-numeric-down me-2"></i>
                                Rank Emotional States
                            </h5>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                Assign a rank from 1 (most consistent) to {{ emotions.count }} (least consistent) 
                                for each emotional state. Each number can only be used once.
                            </div>
                        </div>

                        <!-- Emotional States Ranking -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="5%">Rank</th>
                                        <th width="35%">Emotional State</th>
                                        <th width="50%">Description</th>
                                        <th width="10%">Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for emotion in emotions %}
                                    <tr>
                                        <td class="align-middle">
                                            <span class="badge bg-secondary">{{ forloop.counter }}</span>
                                        </td>
                                        <td class="align-middle">
                                            <strong>{{ emotion.name }}</strong>
                                        </td>
                                        <td class="align-middle">
                                            {% if emotion.description %}
                                                <small class="text-muted">{{ emotion.description }}</small>
                                            {% else %}
                                                <span class="text-muted fst-italic">No description provided</span>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle">
                                            <input type="number" 
                                                   name="emotion_{{ emotion.id }}"
                                                   class="form-control rank-input"
                                                   min="1"
                                                   max="{{ emotions.count }}"
                                                   required
                                                   data-emotion-name="{{ emotion.name }}">
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Validation and Submission -->
                        <div class="mt-5 pt-4 border-top">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="alert alert-warning" id="validationAlert" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="validationMessage"></span>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="validationCheck" required>
                                        <label class="form-check-label" for="validationCheck">
                                            I confirm that I have ranked all emotional states appropriately
                                        </label>
                                        <div class="invalid-feedback">
                                            Please confirm your rankings before proceeding.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="submit" class="btn btn-primary btn-lg px-5">
                                        {% if progress.current == progress.total %}
                                            <i class="fas fa-flag-checkered me-2"></i> Finish Session
                                        {% else %}
                                            <i class="fas fa-arrow-right me-2"></i> Next Image
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                {% else %}
                <!-- No Images Available -->
                <div class="card-body text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h4 class="mb-3">All Images Have Been Rated!</h4>
                    <p class="text-muted mb-4">
                        There are no more images available for classification in this session.
                    </p>
                    <a href="{% url 'session_complete' %}" class="btn btn-success btn-lg px-4">
                        <i class="fas fa-trophy me-2"></i> Complete Session
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Instructions Panel -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i> Classification Instructions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>How to Rank:</h6>
                            <ul class="small">
                                <li class="mb-2">
                                    <strong>1 = Most consistent</strong>: The emotional state that best matches the expression
                                </li>
                                <li class="mb-2">
                                    <strong>{{ emotions.count }} = Least consistent</strong>: The emotional state that least matches the expression
                                </li>
                                <li class="mb-2">
                                    Each number from 1 to {{ emotions.count }} must be used exactly once
                                </li>
                                <li>
                                    Consider the intensity and clarity of the facial expression
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Tips:</h6>
                            <ul class="small">
                                <li class="mb-2">
                                    <i class="fas fa-eye text-primary me-1"></i> Focus on key facial features: eyes, mouth, eyebrows
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-clock text-primary me-1"></i> Take your time - there's no time limit
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-redo text-primary me-1"></i> You can't return to previous images
                                </li>
                                <li>
                                    <i class="fas fa-lock text-primary me-1"></i> Your responses are saved automatically
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Ranking Validation -->
<div class="modal fade" id="rankingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i> Ranking Validation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle me-2"></i>
                    Remember: Each number from 1 to {{ emotions.count }} must be used exactly once.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Review Rankings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('rankingForm');
    const validationCheck = document.getElementById('validationCheck');
    const validationAlert = document.getElementById('validationAlert');
    const validationMessage = document.getElementById('validationMessage');
    const rankInputs = document.querySelectorAll('.rank-input');
    const modal = new bootstrap.Modal(document.getElementById('rankingModal'));
    const modalMessage = document.getElementById('modalMessage');

    // Track used ranks
    function validateRanks() {
        const usedRanks = new Set();
        const duplicates = [];
        const outOfRange = [];
        const missingRanks = new Set(Array.from({length: {{ emotions.count }}}, (_, i) => i + 1));
        
        let isValid = true;
        
        rankInputs.forEach(input => {
            const value = parseInt(input.value);
            
            if (input.value.trim() === '') {
                isValid = false;
                return;
            }
            
            if (value < 1 || value > {{ emotions.count }}) {
                outOfRange.push({
                    name: input.dataset.emotionName,
                    value: value
                });
                isValid = false;
            }
            
            if (usedRanks.has(value)) {
                duplicates.push({
                    name: input.dataset.emotionName,
                    value: value
                });
                isValid = false;
            } else {
                usedRanks.add(value);
                missingRanks.delete(value);
            }
        });
        
        return {
            isValid: isValid && usedRanks.size === {{ emotions.count }},
            duplicates: duplicates,
            outOfRange: outOfRange,
            missingRanks: Array.from(missingRanks)
        };
    }

    // Real-time validation
    rankInputs.forEach(input => {
        input.addEventListener('change', function() {
            const value = parseInt(this.value);
            
            // Clear previous validation
            this.classList.remove('is-invalid', 'is-valid');
            
            // Validate range
            if (value < 1 || value > {{ emotions.count }}) {
                this.classList.add('is-invalid');
                showValidationAlert(`Please enter a number between 1 and {{ emotions.count }}`);
                return;
            }
            
            // Check for duplicates
            const currentValue = value;
            const sameValueInputs = Array.from(rankInputs).filter(inp => 
                inp !== this && parseInt(inp.value) === currentValue
            );
            
            if (sameValueInputs.length > 0) {
                this.classList.add('is-invalid');
                sameValueInputs.forEach(inp => inp.classList.add('is-invalid'));
                showValidationAlert(`Rank ${currentValue} is used multiple times. Each rank must be unique.`);
            } else {
                this.classList.add('is-valid');
                sameValueInputs.forEach(inp => inp.classList.remove('is-invalid'));
                hideValidationAlert();
            }
        });
    });

    function showValidationAlert(message) {
        validationMessage.textContent = message;
        validationAlert.style.display = 'block';
    }

    function hideValidationAlert() {
        validationAlert.style.display = 'none';
    }

    // Form submission validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Check confirmation
        if (!validationCheck.checked) {
            validationCheck.classList.add('is-invalid');
            modalMessage.textContent = 'Please confirm that you have ranked all emotional states appropriately.';
            modal.show();
            return;
        }
        
        // Validate ranks
        const validation = validateRanks();
        
        if (!validation.isValid) {
            let errorMessage = 'Please fix the following issues:';
            
            if (validation.duplicates.length > 0) {
                errorMessage += '\n• Duplicate ranks detected';
            }
            
            if (validation.outOfRange.length > 0) {
                errorMessage += '\n• Some ranks are outside the valid range (1-{{ emotions.count }})';
            }
            
            if (validation.missingRanks.length > 0) {
                errorMessage += `\n• Missing ranks: ${validation.missingRanks.join(', ')}`;
            }
            
            modalMessage.textContent = errorMessage;
            modal.show();
            return;
        }
        
        // If all validations pass, submit the form
        this.submit();
    });

    // Clear validation on checkbox change
    validationCheck.addEventListener('change', function() {
        this.classList.remove('is-invalid');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
            validationCheck.checked = true;
            form.dispatchEvent(new Event('submit'));
        }
        
        // Escape to clear form
        if (e.key === 'Escape') {
            rankInputs.forEach(input => {
                input.value = '';
                input.classList.remove('is-valid', 'is-invalid');
            });
        }
    });

    // Auto-focus first input
    if (rankInputs.length > 0) {
        rankInputs[0].focus();
    }
});
</script>

<style>
.rank-input {
    width: 80px;
    text-align: center;
    font-weight: bold;
}

.rank-input.is-valid {
    border-color: #198754;
    background-color: rgba(25, 135, 84, 0.1);
}

.rank-input.is-invalid {
    border-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

.table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
    transition: background-color 0.2s ease;
}

.card {
    border-radius: 12px;
    overflow: hidden;
}

.btn-lg {
    padding: 0.75rem 2.5rem;
    border-radius: 8px;
    font-weight: 600;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .rank-input {
        width: 60px;
    }
    
    .btn-lg {
        width: 100%;
        margin-top: 1rem;
    }
}

/* Custom scrollbar for table */
.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}