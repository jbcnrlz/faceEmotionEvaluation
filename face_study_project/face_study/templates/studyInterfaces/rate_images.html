{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Rate Facial Expressions{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Session Progress -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Facial Expression Classification</h5>
                        <span class="badge bg-primary">
                            Session {{ progress.current }} of {{ progress.total }}
                        </span>
                    </div>
                </div>
                
                {% if image %}
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <small>Session Progress</small>
                            <small>{{ progress.current }} of {{ progress.total }} images</small>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: {% widthratio progress.current progress.total 100 %}%"
                                 aria-valuenow="{{ progress.current }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ progress.total }}">
                            </div>
                        </div>
                    </div>

                    <!-- Random Session Info -->
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-8">
                                <i class="fas fa-dice me-2"></i>
                                <strong>Random Session Length:</strong> This session contains 
                                <span class="badge bg-primary">{{ progress.total }}</span> images 
                                (randomly selected between {{ progress.min_images }} and {{ progress.max_images }}).
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Estimated: {{ progress.total|mul:2 }} minutes
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Image Display with Rating Limit Info -->
                    <div class="text-center mb-5">
                        <div class="card border-0 bg-light mb-3">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Image Code: <code class="bg-white p-1 rounded">{{ image.code }}</code></h6>
                                    <span class="badge {% if image_rating_info.remaining > 0 %}bg-info{% else %}bg-warning{% endif %}">
                                        <i class="fas fa-users me-1"></i>
                                        {{ image_rating_info.current_count }}/{{ image_rating_info.max_allowed }} ratings
                                    </span>
                                </div>
                                
                                <img src="{{ image.image.url }}" 
                                     alt="Facial expression to classify" 
                                     class="img-fluid rounded shadow mb-3" 
                                     style="max-height: 400px; max-width: 100%;">
                                {% if has_previous_rating %}
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-history me-2"></i>
                                    <strong>Note:</strong> You have rated this image before. Your previous ratings are shown below.
                                    You can adjust them if your perception has changed.
                                </div>
                                {% endif %}
                                <!-- Rating Progress for this Image -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span>Image Rating Progress</span>
                                        <span>{{ image_rating_info.remaining }} more ratings available</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar 
                                            {% if image_rating_info.progress_percent < 50 %}bg-success
                                            {% elif image_rating_info.progress_percent < 80 %}bg-warning
                                            {% else %}bg-danger{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ image_rating_info.progress_percent }}%"
                                             aria-valuenow="{{ image_rating_info.current_count }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="{{ image_rating_info.max_allowed }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Rate how much each emotional state is expressed in this face (0 = not at all, 1 = completely)
                        </p>
                    </div>

                    <!-- Agreement Form -->
                    <form method="post" id="agreementForm">
                        {% csrf_token %}
                        <input type="hidden" name="image_id" value="{{ image.id }}">
                        
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <i class="fas fa-sliders-h me-2"></i>
                                Rate Emotional States Agreement
                            </h5>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                For each emotional state below, indicate how much you agree that it is expressed in the face above.
                                Use the sliders to rate from 0 (completely disagree) to 1 (completely agree).
                                Multiple emotions can have the same rating. Faces can have no or very low emotions and there is no need to select one necessarily.
                            </div>
                            
                            <!-- Agreement Legend -->
                            <div class="agreement-legend mb-3">
                                <div class="d-flex justify-content-between small text-muted">
                                    <span><i class="fas fa-times-circle me-1"></i> I don't perceive this emotion at all (0)</span>
                                    <span>Adjust sliders independently</span>
                                    <span>This emotion is very clearly expressed (1) <i class="fas fa-check-circle ms-1"></i></span>
                                </div>
                            </div>
                        </div>

                        <!-- Emotional States Agreement with Sliders -->
                        <div class="emotion-agreement-container">
                            {% for emotion in emotions %}
                            <div class="emotion-agreement-card mb-3 p-3 border rounded" data-emotion-id="{{ emotion.id }}">
                                <div class="row align-items-center">
                                    <!-- Emotion Info -->
                                    <div class="col-md-3">
                                        <h6 class="mb-1">{{ emotion.name }}</h6>
                                        {% if emotion.description %}
                                        <small class="text-muted">{{ emotion.description|truncatechars:60 }}</small>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Slider -->
                                    <div class="col-md-6">
                                        <div class="slider-container">
                                            <div class="d-flex justify-content-between mb-1">
                                                <small class="text-muted">0.0</small>
                                                <small class="text-muted">0.5</small>
                                                <small class="text-muted">1.0</small>
                                            </div>
                                            <input type="range" 
                                                   class="form-range agreement-slider"
                                                   min="0"
                                                   max="1"
                                                   step="0.01"
                                                   value="0.5"
                                                   data-emotion-id="{{ emotion.id }}"
                                                   data-emotion-name="{{ emotion.name }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Numeric Input and Display -->
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <input type="number" 
                                                   name="emotion_{{ emotion.id }}"
                                                   class="form-control agreement-input text-center"
                                                   min="0"
                                                   max="1"
                                                   step="0.01"
                                                   value="0.50"
                                                   data-emotion-id="{{ emotion.id }}"
                                                   required>
                                            <span class="input-group-text">/1.00</span>
                                        </div>
                                        <div class="agreement-display mt-2 text-center">
                                            <div class="agreement-value-badge">
                                                <span class="badge 
                                                    {% if emotion.id|stringformat:'s' in form.initial %}
                                                        {% with value=form.initial.emotion_id %}
                                                            {% if value < 0.33 %}bg-danger
                                                            {% elif value < 0.66 %}bg-warning
                                                            {% else %}bg-success{% endif %}
                                                        {% endwith %}
                                                    {% else %}bg-secondary{% endif %}
                                                    agreement-value" 
                                                      style="font-size: 0.9rem; min-width: 60px;">
                                                    <span class="agreement-number">0.50</span>
                                                </span>
                                            </div>
                                            <small class="text-muted d-block mt-1">Agreement Level</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Agreement Summary -->
                        <div class="card mt-4 mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i> Agreement Summary
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="agreement-distribution-chart">
                                            <div class="d-flex align-items-center mb-2">
                                                <small class="text-muted me-3">Distribution:</small>
                                                <div class="d-flex flex-wrap gap-1" id="agreementDistribution">
                                                    <!-- Will be filled by JavaScript -->
                                                </div>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-danger" style="width: 0%;" 
                                                     id="lowAgreementBar" data-toggle="tooltip" title="Low (0.0-0.33)">
                                                    <small>Low</small>
                                                </div>
                                                <div class="progress-bar bg-warning" style="width: 0%;" 
                                                     id="mediumAgreementBar" data-toggle="tooltip" title="Medium (0.34-0.66)">
                                                    <small>Medium</small>
                                                </div>
                                                <div class="progress-bar bg-success" style="width: 0%;" 
                                                     id="highAgreementBar" data-toggle="tooltip" title="High (0.67-1.00)">
                                                    <small>High</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="agreement-stats">
                                            <h6 class="mb-2">Statistics</h6>
                                            <div class="d-flex justify-content-between mb-1">
                                                <small>Average:</small>
                                                <small id="averageAgreement">0.50</small>
                                            </div>
                                            <div class="d-flex justify-content-between mb-1">
                                                <small>Highest:</small>
                                                <small id="highestAgreement">0.50</small>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <small>Lowest:</small>
                                                <small id="lowestAgreement">0.50</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Each emotional state is rated independently. There's no limit on how many can have the same rating.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Validation and Submission -->
                        <div class="mt-5 pt-4 border-top">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="alert alert-warning" id="validationAlert" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <span id="validationMessage"></span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                        {% if progress.current == progress.total %}
                                            <i class="fas fa-flag-checkered me-2"></i> Finish Session
                                        {% else %}
                                            <i class="fas fa-arrow-right me-2"></i> Next Image
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                {% else %}
                <!-- No Images Available -->
                <div class="card-body text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h4 class="mb-3">All Images Have Been Rated!</h4>
                    <p class="text-muted mb-4">
                        There are no more images available for classification in this session.
                    </p>
                    <a href="{% url 'faceStudy:session_complete' %}" class="btn btn-success btn-lg px-4">
                        <i class="fas fa-trophy me-2"></i> Complete Session
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Instructions Panel -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i> Rating Instructions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>How to Rate Agreement:</h6>
                            <ul class="small">
                                <li class="mb-2">
                                    <strong>0.0 (Completely disagree)</strong>: The emotional state is not expressed at all
                                </li>
                                <li class="mb-2">
                                    <strong>0.5 (Neutral/Moderate)</strong>: The emotional state is somewhat expressed
                                </li>
                                <li class="mb-2">
                                    <strong>1.0 (Completely agree)</strong>: The emotional state is fully and clearly expressed
                                </li>
                                <li class="mb-2">
                                    <strong>Independent ratings</strong>: Each emotion is rated separately
                                </li>
                                <li>
                                    <strong>Same ratings allowed</strong>: Multiple emotions can have identical ratings
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Rating Tips:</h6>
                            <ul class="small">
                                <li class="mb-2">
                                    <i class="fas fa-eye text-primary me-1"></i> Consider the overall facial expression and subtle cues
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-balance-scale text-primary me-1"></i> Rate based on how clearly the emotion is expressed
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-sync-alt text-primary me-1"></i> You can adjust ratings as many times as needed
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-th text-primary me-1"></i> It's okay to give the same rating to different emotions
                                </li>
                                <li>
                                    <i class="fas fa-check-double text-primary me-1"></i> All emotions must be rated before submitting
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('agreementForm');
    const validationAlert = document.getElementById('validationAlert');
    const validationMessage = document.getElementById('validationMessage');
    const sliders = document.querySelectorAll('.agreement-slider');
    const inputs = document.querySelectorAll('.agreement-input');
    const submitBtn = document.getElementById('submitBtn');
    
    // Initialize all emotions with default value
    initializeEmotions();
    
    // Update statistics on load
    updateStatistics();
    
    // Slider change handler
    sliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const emotionId = this.dataset.emotionId;
            const value = parseFloat(this.value);
            
            // Update corresponding input
            const input = document.querySelector(`input[name="emotion_${emotionId}"]`);
            if (input) {
                input.value = value.toFixed(2);
                updateEmotionDisplay(emotionId, value);
            }
            
            updateStatistics();
        });
    });
    
    // Input change handler
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            let value = parseFloat(this.value);
            
            // Validate range
            if (isNaN(value)) value = 0.5;
            if (value < 0) value = 0;
            if (value > 1) value = 1;
            
            this.value = value.toFixed(2);
            
            const emotionId = this.dataset.emotionId;
            
            // Update corresponding slider
            const slider = document.querySelector(`.agreement-slider[data-emotion-id="${emotionId}"]`);
            if (slider) {
                slider.value = value;
                updateEmotionDisplay(emotionId, value);
            }
            
            updateStatistics();
        });
        
        input.addEventListener('input', function() {
            // Real-time validation while typing
            let value = parseFloat(this.value);
            if (!isNaN(value)) {
                if (value < 0) this.value = '0';
                if (value > 1) this.value = '1';
            }
        });
    });
    
    function initializeEmotions() {
        sliders.forEach(slider => {
            const emotionId = slider.dataset.emotionId;
            const value = parseFloat(slider.value);
            updateEmotionDisplay(emotionId, value);
        });
    }
    
    function updateEmotionDisplay(emotionId, value) {
        const emotionCard = document.querySelector(`[data-emotion-id="${emotionId}"]`);
        const badge = emotionCard.querySelector('.agreement-value');
        const numberSpan = emotionCard.querySelector('.agreement-number');
        
        // Update badge text
        numberSpan.textContent = value.toFixed(2);
        
        // Update badge color based on value
        if (value < 0.33) {
            badge.className = 'badge bg-danger agreement-value';
        } else if (value < 0.67) {
            badge.className = 'badge bg-warning agreement-value';
        } else {
            badge.className = 'badge bg-success agreement-value';
        }
    }
    
    function updateStatistics() {
        const values = [];
        sliders.forEach(slider => {
            values.push(parseFloat(slider.value));
        });
        
        if (values.length > 0) {
            // Calculate statistics
            const sum = values.reduce((a, b) => a + b, 0);
            const average = sum / values.length;
            const highest = Math.max(...values);
            const lowest = Math.min(...values);
            
            // Update display
            document.getElementById('averageAgreement').textContent = average.toFixed(2);
            document.getElementById('highestAgreement').textContent = highest.toFixed(2);
            document.getElementById('lowestAgreement').textContent = lowest.toFixed(2);
            
            // Update distribution bars
            updateDistributionBars(values);
            
            // Update distribution dots
            updateDistributionDots(values);
        }
    }
    
    function updateDistributionBars(values) {
        const low = values.filter(v => v < 0.34).length;
        const medium = values.filter(v => v >= 0.34 && v < 0.67).length;
        const high = values.filter(v => v >= 0.67).length;
        const total = values.length;
        
        const lowPercent = (low / total) * 100;
        const mediumPercent = (medium / total) * 100;
        const highPercent = (high / total) * 100;
        
        document.getElementById('lowAgreementBar').style.width = `${lowPercent}%`;
        document.getElementById('mediumAgreementBar').style.width = `${mediumPercent}%`;
        document.getElementById('highAgreementBar').style.width = `${highPercent}%`;
        
        // Update tooltips
        document.getElementById('lowAgreementBar').title = `Low (0.0-0.33): ${low} emotions`;
        document.getElementById('mediumAgreementBar').title = `Medium (0.34-0.66): ${medium} emotions`;
        document.getElementById('highAgreementBar').title = `High (0.67-1.00): ${high} emotions`;
    }
    
    function updateDistributionDots(values) {
        const container = document.getElementById('agreementDistribution');
        container.innerHTML = '';
        
        // Sort values and create visual representation
        const sortedValues = [...values].sort((a, b) => a - b);
        sortedValues.forEach(value => {
            const dot = document.createElement('div');
            dot.style.width = '12px';
            dot.style.height = '12px';
            dot.style.borderRadius = '50%';
            dot.style.display = 'inline-block';
            dot.style.margin = '0 2px';
            dot.style.cursor = 'pointer';
            
            if (value < 0.34) {
                dot.style.backgroundColor = '#dc3545'; // Red for low
            } else if (value < 0.67) {
                dot.style.backgroundColor = '#ffc107'; // Yellow for medium
            } else {
                dot.style.backgroundColor = '#198754'; // Green for high
            }
            
            dot.title = `Rating: ${value.toFixed(2)}`;
            container.appendChild(dot);
        });
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
                
        // Validate all inputs have values
        let allValid = true;
        inputs.forEach(input => {
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0 || value > 1) {
                input.classList.add('is-invalid');
                allValid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });
        
        if (!allValid) {
            showValidationAlert('Please ensure all ratings are valid numbers between 0 and 1.');
            return;
        }
        
        // If all validations pass, submit the form
        this.submit();
    });
    
    function showValidationAlert(message) {
        validationMessage.textContent = message;
        validationAlert.style.display = 'block';
        validationAlert.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
            form.dispatchEvent(new Event('submit'));
        }
    });
});
</script>

<style>
/* Agreement Slider Styles */
.emotion-agreement-card {
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    border-left: 4px solid #4e73df !important;
}

.emotion-agreement-card:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.form-range.agreement-slider {
    height: 8px;
    cursor: pointer;
}

.form-range.agreement-slider::-webkit-slider-thumb {
    background-color: #4e73df;
    border: 2px solid #fff;
    width: 20px;
    height: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.form-range.agreement-slider::-moz-range-thumb {
    background-color: #4e73df;
    border: 2px solid #fff;
    width: 20px;
    height: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.form-range.agreement-slider::-webkit-slider-runnable-track {
    background: linear-gradient(to right, #dc3545, #ffc107, #198754);
    height: 8px;
    border-radius: 4px;
}

.form-range.agreement-slider::-moz-range-track {
    background: linear-gradient(to right, #dc3545, #ffc107, #198754);
    height: 8px;
    border-radius: 4px;
}

/* Agreement Input Styles */
.agreement-input {
    text-align: center;
    font-weight: bold;
}

.agreement-input:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
}

.agreement-value {
    font-size: 0.9rem;
    min-width: 60px;
    display: inline-block;
    transition: all 0.3s ease;
}

/* Progress Bar Animation */
.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

/* Distribution Chart */
.agreement-distribution-chart .progress {
    border-radius: 10px;
    overflow: hidden;
}

.agreement-distribution-chart .progress-bar {
    transition: width 0.5s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .emotion-agreement-card {
        padding: 1rem !important;
    }
    
    .emotion-agreement-card .row > div {
        margin-bottom: 0.5rem;
    }
    
    .btn-lg {
        width: 100%;
        margin-top: 1rem;
    }
    
    .agreement-legend {
        font-size: 0.8rem;
    }
}

/* Custom scrollbar for agreement container */
.emotion-agreement-container {
    max-height: 500px;
    overflow-y: auto;
    padding-right: 5px;
}

.emotion-agreement-container::-webkit-scrollbar {
    width: 8px;
}

.emotion-agreement-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.emotion-agreement-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.emotion-agreement-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Input group adjustments */
.input-group-text {
    background-color: #e9ecef;
    color: #495057;
    font-size: 0.875rem;
}

/* Stats panel */
.agreement-stats {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.agreement-stats h6 {
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.5rem;
}
</style>
{% endblock %}